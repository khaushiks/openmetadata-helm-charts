# Default values for deps.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# MySQL configurations for helm dependency
# you can find more details about this here https://artifacthub.io/packages/helm/bitnami/mysql
global:
  security:
    allowInsecureImages: true

cronJobLabels: {}

mysql:
  enabled: true
  fullnameOverride: "mysql"
  architecture: standalone
  image:
    registry: docker.io
    repository: bitnamilegacy/mysql
    tag: 8.0.37-debian-12-r2
    pullPolicy: "Always"
  auth:
    rootPassword: password    # to be provided by CI/CD
  primary:
    extraFlags: "--sort_buffer_size=10M"
    persistence:
      size: 10Gi  # Reduced for dev
      storageClass: "default"
    service:
      nodePort: 3306
  initdbScripts:
    init_openmetadata_db_scripts.sql: |
      CREATE DATABASE openmetadata_db;
      CREATE USER 'openmetadata_user'@'%' IDENTIFIED BY 'openmetadata_password';
      GRANT ALL PRIVILEGES ON openmetadata_db.* TO 'openmetadata_user'@'%' WITH GRANT OPTION;
      commit;
    init_airflow_db_scripts.sql: |
      CREATE DATABASE airflow_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
      CREATE USER 'airflow_user'@'%' IDENTIFIED BY 'airflow_pass';
      GRANT ALL PRIVILEGES ON airflow_db.* TO 'airflow_user'@'%' WITH GRANT OPTION;
      commit;

# OpenSearch Helm Dependency
# you can find more details about this here https://artifacthub.io/packages/helm/opensearch-project-helm-charts/opensearch/2.12.2
opensearch:
  enabled: true
  clusterName: opensearch
  fullnameOverride: opensearch
  nodeGroup: ""
  imagePullPolicy: Always
  opensearchJavaOpts: "-Xmx2g -Xms2g"  # Match 4Gi container memory
  persistence:
    size: 10Gi  # Reduced for dev
    storageClass: "default"
  protocol: http
  config:
    opensearch.yml: |
      plugins.security.disabled: true
      indices.query.bool.max_clause_count: 4096
  singleNode: true
  resources:
    requests:
      cpu: "1000m"
      memory: "4Gi"
    limits:
      cpu: "2000m"
      memory: "4Gi"
  extraEnvs:
    - name: OPENSEARCH_INITIAL_ADMIN_PASSWORD
      value: "IXRZqiqBXQSOkSDQ4jL1n2CYPeNQz8IuXNHyQCVsU8="  # Strong random password (no slashes)

# Airflow configurations for helm dependency
# you can find more details about this here https://airflow.apache.org/docs/helm-chart/
airflow:
  enabled: true
  # Static secret key for Airflow webserver
  webserverSecretKey: "a5f8c3e2d1b9a7f6e4c3b2a1f9e8d7c6b5a4f3e2d1c9b8a7f6e5d4c3b2a1f0e9"
  # Use OpenMetadata Airflow image with Airflow 3
  images:
    airflow:
      repository: docker.getcollate.io/openmetadata/ingestion
      tag: 1.11.4
      pullPolicy: "IfNotPresent"
  # Use KubernetesExecutor for production
  executor: "KubernetesExecutor"
  # Environment variables
  env:
    - name: AIRFLOW__API__AUTH_BACKENDS
      value: "airflow.api.auth.backend.session,airflow.api.auth.backend.basic_auth"
    - name: AIRFLOW__OPENMETADATA_AIRFLOW_APIS__DAG_GENERATED_CONFIGS
      value: "/opt/airflow/dags"
    - name: _PIP_ADDITIONAL_REQUIREMENTS
      value: "apache-airflow-providers-fab==2.4.4"
  # Create admin user
  webserver:
    defaultUser:
      enabled: true
      role: Admin
      username: admin
      email: admin@openmetadata.org
      firstName: Admin
      lastName: User
      password: admin
  # Disable internal PostgreSQL, use external MySQL
  postgresql:
    enabled: false
  # Reduce resources for AKS
  workers:
    replicas: 1
    resources:
      requests:
        memory: "64Mi"
        cpu: "25m"
      limits:
        memory: "512Mi"
        cpu: "200m"
  scheduler:
    resources:
      requests:
        memory: "64Mi"
        cpu: "25m"
      limits:
        memory: "512Mi"
        cpu: "200m"
  webserver:
    resources:
      requests:
        memory: "64Mi"
        cpu: "25m"
      limits:
        memory: "512Mi"
        cpu: "200m"
  statsd:
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
  redis:
    enabled: false
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
  # Disable Flower
  flower:
    enabled: false
  # Configure external MySQL
  data:
    metadataConnection:
      user: airflow_user
      pass: airflow_pass
      protocol: mysql
      host: mysql
      port: 3306
      db: airflow_db
      sslmode: disable
  # DAGs persistence - MUST use "default" for Azure Disk
  dags:
    persistence:
      enabled: true
      storageClassName: "default"
      size: 1Gi
  # Logs persistence - MUST use "default" for Azure Disk
  logs:
    persistence:
      enabled: true
      storageClassName: "default"
      size: 1Gi
  # Disable triggerer to save resources
  triggerer:
    enabled: false
  # Mount logs volume to all components
  scheduler:
    extraVolumes:
      - name: logs
        persistentVolumeClaim:
          claimName: '{{ include "airflow.fullname" . }}-logs'
    extraVolumeMounts:
      - name: logs
        mountPath: /opt/airflow/logs
  webserver:
    extraVolumes:
      - name: logs
        persistentVolumeClaim:
          claimName: '{{ include "airflow.fullname" . }}-logs'
    extraVolumeMounts:
      - name: logs
        mountPath: /opt/airflow/logs
  workers:
    extraVolumes:
      - name: logs
        persistentVolumeClaim:
          claimName: '{{ include "airflow.fullname" . }}-logs'
    extraVolumeMounts:
      - name: logs
        mountPath: /opt/airflow/logs
  # API server needs DAGs and logs volumes
  apiServer:
    extraVolumes:
      - name: dags
        persistentVolumeClaim:
          claimName: '{{ include "airflow.fullname" . }}-dags'
      - name: logs
        persistentVolumeClaim:
          claimName: '{{ include "airflow.fullname" . }}-logs'
    extraVolumeMounts:
      - name: dags
        mountPath: /opt/airflow/dags
      - name: logs
        mountPath: /opt/airflow/logs
